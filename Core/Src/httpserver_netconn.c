/**
  ******************************************************************************
  * @file    LwIP/LwIP_HTTP_Server_Netconn_RTOS/Src/httpser-netconn.c
  * @author  MCD Application Team
  * @brief   Basic http server implementation using LwIP netconn API  
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2017 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */

/* Includes ------------------------------------------------------------------*/
#include "lwip/opt.h"
#include "lwip/arch.h"
#include "lwip/api.h"
#include "lwip/apps/fs.h"
#include "string.h"
#include "httpserver_netconn.h"
#include "cmsis_os.h"

#include <stdio.h>
#include "page.h"
#include "pp.h"
#include "stm32h7xx_nucleo.h"



/* Private typedef -----------------------------------------------------------*/
/* Private define ------------------------------------------------------------*/
#define WEBSERVER_THREAD_PRIO    ( osPriorityAboveNormal )

/* Private macro -------------------------------------------------------------*/
/* Private variables ---------------------------------------------------------*/
u32_t nPageHits = 0;

/* Format of dynamic web page: the page header */
static const unsigned char PAGE_START[] = {0x3c, 0x21, 0x44, 0x4f, 0x43, 0x54, 0x59, 0x50, 0x45, 0x20, 0x68, 0x74, 0x6d, 0x6c, 0x20, 0x50, 0x55, 0x42, 0x4c, 0x49, 0x43, 0x20, 0x22,
                                           0x2d, 0x2f, 0x2f, 0x57, 0x33, 0x43, 0x2f, 0x2f, 0x44, 0x54, 0x44, 0x20, 0x48, 0x54, 0x4d, 0x4c, 0x20, 0x34, 0x2e, 0x30, 0x31, 0x2f, 0x2f,
                                           0x45, 0x4e, 0x22, 0x20, 0x22, 0x68, 0x74, 0x74, 0x70, 0x3a, 0x2f, 0x2f, 0x77, 0x77, 0x77, 0x2e, 0x77, 0x33, 0x2e, 0x6f, 0x72, 0x67, 0x2f,
                                           0x54, 0x52, 0x2f, 0x68, 0x74, 0x6d, 0x6c, 0x34, 0x2f, 0x73, 0x74, 0x72, 0x69, 0x63, 0x74, 0x2e, 0x64, 0x74, 0x64, 0x22, 0x3e, 0x0a, 0x3c,
                                           0x68, 0x74, 0x6d, 0x6c, 0x3e, 0x3c, 0x68, 0x65, 0x61, 0x64, 0x3e, 0x3c, 0x74, 0x69, 0x74, 0x6c, 0x65, 0x3e, 0x53, 0x54, 0x4d, 0x33, 0x32,
                                           0x48, 0x37, 0x78, 0x78, 0x54, 0x41, 0x53, 0x4b, 0x53, 0x3c, 0x2f, 0x74, 0x69, 0x74, 0x6c, 0x65, 0x3e, 0x0d, 0x0a, 0x0d, 0x0a, 0x3c, 0x6d,
                                           0x65, 0x74, 0x61, 0x20, 0x68, 0x74, 0x74, 0x70, 0x2d, 0x65, 0x71, 0x75, 0x69, 0x76, 0x3d, 0x22, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74,
                                           0x2d, 0x54, 0x79, 0x70, 0x65, 0x22, 0x20, 0x63, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x3d, 0x22, 0x74, 0x65, 0x78, 0x74, 0x2f, 0x68, 0x74,
                                           0x6d, 0x6c, 0x3b, 0x20, 0x63, 0x68, 0x61, 0x72, 0x73, 0x65, 0x74, 0x3d, 0x77, 0x69, 0x6e, 0x64, 0x6f, 0x77, 0x73, 0x2d, 0x31, 0x32, 0x35,
                                           0x32, 0x22, 0x3e, 0x0d, 0x0a, 0x3c, 0x6d, 0x65, 0x74, 0x61, 0x20, 0x68, 0x74, 0x74, 0x70, 0x2d, 0x65, 0x71, 0x75, 0x69, 0x76, 0x3d, 0x22,
                                           0x72, 0x65, 0x66, 0x72, 0x65, 0x73, 0x68, 0x22, 0x20, 0x63, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x3d, 0x22, 0x31, 0x22, 0x3e, 0x0d, 0x0a,
                                           0x3c, 0x6d, 0x65, 0x74, 0x61, 0x20, 0x63, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x3d, 0x22, 0x4d, 0x53, 0x48, 0x54, 0x4d, 0x4c, 0x20, 0x36,
                                           0x2e, 0x30, 0x30, 0x2e, 0x32, 0x38, 0x30, 0x30, 0x2e, 0x31, 0x35, 0x36, 0x31, 0x22, 0x20, 0x6e, 0x61, 0x6d, 0x65, 0x3d, 0x22, 0x47, 0x45,
                                           0x4e, 0x45, 0x52, 0x41, 0x54, 0x4f, 0x52, 0x22, 0x3e, 0x0d, 0x0a, 0x3c, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x20, 0x3d, 0x22, 0x66, 0x6f, 0x6e,
                                           0x74, 0x2d, 0x77, 0x65, 0x69, 0x67, 0x68, 0x74, 0x3a, 0x20, 0x6e, 0x6f, 0x72, 0x6d, 0x61, 0x6c, 0x3b, 0x20, 0x66, 0x6f, 0x6e, 0x74, 0x2d,
                                           0x66, 0x61, 0x6d, 0x69, 0x6c, 0x79, 0x3a, 0x20, 0x56, 0x65, 0x72, 0x64, 0x61, 0x6e, 0x61, 0x3b, 0x22, 0x3e, 0x3c, 0x2f, 0x73, 0x74, 0x79,
                                           0x6c, 0x65, 0x3e, 0x0d, 0x0a, 0x3c, 0x2f, 0x68, 0x65, 0x61, 0x64, 0x3e, 0x0d, 0x0a, 0x0d, 0x0a, 0x3c, 0x62, 0x6f, 0x64, 0x79, 0x3e, 0x0d,
                                           0x0a, 0x3c, 0x68, 0x34, 0x20, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x3d, 0x22, 0x63, 0x6f, 0x6c, 0x6f, 0x72, 0x3a, 0x20, 0x72, 0x67, 0x62, 0x28,
                                           0x35, 0x31, 0x2c, 0x20, 0x35, 0x31, 0x2c, 0x20, 0x32, 0x35, 0x35, 0x29, 0x3b, 0x22, 0x3e, 0x3c, 0x73, 0x6d, 0x61, 0x6c, 0x6c, 0x20, 0x73,
                                           0x74, 0x79, 0x6c, 0x65, 0x3d, 0x22, 0x66, 0x6f, 0x6e, 0x74, 0x2d, 0x66, 0x61, 0x6d, 0x69, 0x6c, 0x79, 0x3a, 0x20, 0x56, 0x65, 0x72, 0x64,
                                           0x61, 0x6e, 0x61, 0x3b, 0x22, 0x3e, 0x3c, 0x73, 0x6d, 0x61, 0x6c, 0x6c, 0x3e, 0x3c, 0x62, 0x69, 0x67, 0x3e, 0x3c, 0x62, 0x69, 0x67, 0x3e,
                                           0x3c, 0x62, 0x69, 0x67, 0x20, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x3d, 0x22, 0x66, 0x6f, 0x6e, 0x74, 0x2d, 0x77, 0x65, 0x69, 0x67, 0x68, 0x74,
                                           0x3a, 0x20, 0x62, 0x6f, 0x6c, 0x64, 0x3b, 0x22, 0x3e, 0x3c, 0x62, 0x69, 0x67, 0x3e, 0x3c, 0x73, 0x74, 0x72, 0x6f, 0x6e, 0x67, 0x3e, 0x3c,
                                           0x65, 0x6d, 0x3e, 0x3c, 0x73, 0x70, 0x61, 0x6e, 0x20, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x3d, 0x22, 0x66, 0x6f, 0x6e, 0x74, 0x2d, 0x73, 0x74,
                                           0x79, 0x6c, 0x65, 0x3a, 0x20, 0x69, 0x74, 0x61, 0x6c, 0x69, 0x63, 0x3b, 0x22, 0x3e, 0x53, 0x54, 0x4d, 0x33, 0x32, 0x48, 0x37, 0x78, 0x78,
                                           0x20, 0x4c, 0x69, 0x73, 0x74, 0x20, 0x6f, 0x66, 0x20, 0x74, 0x61, 0x73, 0x6b, 0x73, 0x20, 0x61, 0x6e, 0x64, 0x0d, 0x0a, 0x74, 0x68, 0x65,
                                           0x69, 0x72, 0x20, 0x73, 0x74, 0x61, 0x74, 0x75, 0x73, 0x3c, 0x2f, 0x73, 0x70, 0x61, 0x6e, 0x3e, 0x3c, 0x2f, 0x65, 0x6d, 0x3e, 0x3c, 0x2f,
                                           0x73, 0x74, 0x72, 0x6f, 0x6e, 0x67, 0x3e, 0x3c, 0x2f, 0x62, 0x69, 0x67, 0x3e, 0x3c, 0x2f, 0x62, 0x69, 0x67, 0x3e, 0x3c, 0x2f, 0x62, 0x69,
                                           0x67, 0x3e, 0x3c, 0x2f, 0x62, 0x69, 0x67, 0x3e, 0x3c, 0x2f, 0x73, 0x6d, 0x61, 0x6c, 0x6c, 0x3e, 0x3c, 0x2f, 0x73, 0x6d, 0x61, 0x6c, 0x6c,
                                           0x3e, 0x3c, 0x2f, 0x68, 0x34, 0x3e, 0x0d, 0x0a, 0x3c, 0x68, 0x72, 0x20, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x3d, 0x22, 0x77, 0x69, 0x64, 0x74,
                                           0x68, 0x3a, 0x20, 0x31, 0x30, 0x30, 0x25, 0x3b, 0x20, 0x68, 0x65, 0x69, 0x67, 0x68, 0x74, 0x3a, 0x20, 0x32, 0x70, 0x78, 0x3b, 0x22, 0x3e,
                                           0x3c, 0x73, 0x70, 0x61, 0x6e, 0x20, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x3d, 0x22, 0x66, 0x6f, 0x6e, 0x74, 0x2d, 0x77, 0x65, 0x69, 0x67, 0x68,
                                           0x74, 0x3a, 0x20, 0x62, 0x6f, 0x6c, 0x64, 0x3b, 0x22, 0x3e, 0x0d, 0x0a, 0x3c, 0x2f, 0x73, 0x70, 0x61, 0x6e, 0x3e, 0x3c, 0x73, 0x70, 0x61,
                                           0x6e, 0x20, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x3d, 0x22, 0x66, 0x6f, 0x6e, 0x74, 0x2d, 0x77, 0x65, 0x69, 0x67, 0x68, 0x74, 0x3a, 0x20, 0x62,
                                           0x6f, 0x6c, 0x64, 0x3b, 0x22, 0x3e, 0x0d, 0x0a, 0x3c, 0x74, 0x61, 0x62, 0x6c, 0x65, 0x20, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x3d, 0x22, 0x77,
                                           0x69, 0x64, 0x74, 0x68, 0x3a, 0x20, 0x39, 0x36, 0x31, 0x70, 0x78, 0x3b, 0x20, 0x68, 0x65, 0x69, 0x67, 0x68, 0x74, 0x3a, 0x20, 0x33, 0x30,
                                           0x70, 0x78, 0x3b, 0x22, 0x20, 0x62, 0x6f, 0x72, 0x64, 0x65, 0x72, 0x3d, 0x22, 0x31, 0x22, 0x20, 0x63, 0x65, 0x6c, 0x6c, 0x70, 0x61, 0x64,
                                           0x64, 0x69, 0x6e, 0x67, 0x3d, 0x22, 0x32, 0x22, 0x20, 0x63, 0x65, 0x6c, 0x6c, 0x73, 0x70, 0x61, 0x63, 0x69, 0x6e, 0x67, 0x3d, 0x22, 0x32,
                                           0x22, 0x3e, 0x0d, 0x0a, 0x3c, 0x74, 0x62, 0x6f, 0x64, 0x79, 0x3e, 0x0d, 0x0a, 0x3c, 0x74, 0x72, 0x3e, 0x0d, 0x0a, 0x3c, 0x74, 0x64, 0x20,
                                           0x73, 0x74, 0x79, 0x6c, 0x65, 0x3d, 0x22, 0x66, 0x6f, 0x6e, 0x74, 0x2d, 0x66, 0x61, 0x6d, 0x69, 0x6c, 0x79, 0x3a, 0x20, 0x56, 0x65, 0x72,
                                           0x64, 0x61, 0x6e, 0x61, 0x3b, 0x20, 0x66, 0x6f, 0x6e, 0x74, 0x2d, 0x77, 0x65, 0x69, 0x67, 0x68, 0x74, 0x3a, 0x20, 0x62, 0x6f, 0x6c, 0x64,
                                           0x3b, 0x20, 0x66, 0x6f, 0x6e, 0x74, 0x2d, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x3a, 0x20, 0x69, 0x74, 0x61, 0x6c, 0x69, 0x63, 0x3b, 0x20, 0x62,
                                           0x61, 0x63, 0x6b, 0x67, 0x72, 0x6f, 0x75, 0x6e, 0x64, 0x2d, 0x63, 0x6f, 0x6c, 0x6f, 0x72, 0x3a, 0x20, 0x72, 0x67, 0x62, 0x28, 0x35, 0x31,
                                           0x2c, 0x20, 0x35, 0x31, 0x2c, 0x20, 0x32, 0x35, 0x35, 0x29, 0x3b, 0x20, 0x74, 0x65, 0x78, 0x74, 0x2d, 0x61, 0x6c, 0x69, 0x67, 0x6e, 0x3a,
                                           0x20, 0x63, 0x65, 0x6e, 0x74, 0x65, 0x72, 0x3b, 0x22, 0x3e, 0x3c, 0x73, 0x6d, 0x61, 0x6c, 0x6c, 0x3e, 0x3c, 0x61, 0x20, 0x68, 0x72, 0x65,
                                           0x66, 0x3d, 0x22, 0x2f, 0x53, 0x54, 0x4d, 0x33, 0x32, 0x48, 0x37, 0x78, 0x78, 0x2e, 0x68, 0x74, 0x6d, 0x6c, 0x22, 0x3e, 0x3c, 0x73, 0x70,
                                           0x61, 0x6e, 0x20, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x3d, 0x22, 0x63, 0x6f, 0x6c, 0x6f, 0x72, 0x3a, 0x20, 0x77, 0x68, 0x69, 0x74, 0x65, 0x3b,
                                           0x22, 0x3e, 0x48, 0x6f, 0x6d, 0x65, 0x0d, 0x0a, 0x70, 0x61, 0x67, 0x65, 0x3c, 0x2f, 0x73, 0x70, 0x61, 0x6e, 0x3e, 0x3c, 0x2f, 0x61, 0x3e,
                                           0x3c, 0x2f, 0x73, 0x6d, 0x61, 0x6c, 0x6c, 0x3e, 0x3c, 0x2f, 0x74, 0x64, 0x3e, 0x0d, 0x0a, 0x3c, 0x74, 0x64, 0x20, 0x73, 0x74, 0x79, 0x6c,
                                           0x65, 0x3d, 0x22, 0x66, 0x6f, 0x6e, 0x74, 0x2d, 0x66, 0x61, 0x6d, 0x69, 0x6c, 0x79, 0x3a, 0x20, 0x56, 0x65, 0x72, 0x64, 0x61, 0x6e, 0x61,
                                           0x3b, 0x20, 0x66, 0x6f, 0x6e, 0x74, 0x2d, 0x77, 0x65, 0x69, 0x67, 0x68, 0x74, 0x3a, 0x20, 0x62, 0x6f, 0x6c, 0x64, 0x3b, 0x20, 0x66, 0x6f,
                                           0x6e, 0x74, 0x2d, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x3a, 0x20, 0x69, 0x74, 0x61, 0x6c, 0x69, 0x63, 0x3b, 0x20, 0x62, 0x61, 0x63, 0x6b, 0x67,
                                           0x72, 0x6f, 0x75, 0x6e, 0x64, 0x2d, 0x63, 0x6f, 0x6c, 0x6f, 0x72, 0x3a, 0x20, 0x72, 0x67, 0x62, 0x28, 0x35, 0x31, 0x2c, 0x20, 0x35, 0x31,
                                           0x2c, 0x20, 0x32, 0x35, 0x35, 0x29, 0x3b, 0x20, 0x74, 0x65, 0x78, 0x74, 0x2d, 0x61, 0x6c, 0x69, 0x67, 0x6e, 0x3a, 0x20, 0x63, 0x65, 0x6e,
                                           0x74, 0x65, 0x72, 0x3b, 0x22, 0x3e, 0x3c, 0x61, 0x20, 0x68, 0x72, 0x65, 0x66, 0x3d, 0x22, 0x53, 0x54, 0x4d, 0x33, 0x32, 0x48, 0x37, 0x78,
                                           0x78, 0x41, 0x44, 0x43, 0x2e, 0x68, 0x74, 0x6d, 0x6c, 0x22, 0x3e, 0x3c, 0x73, 0x70, 0x61, 0x6e, 0x20, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x3d,
                                           0x22, 0x66, 0x6f, 0x6e, 0x74, 0x2d, 0x77, 0x65, 0x69, 0x67, 0x68, 0x74, 0x3a, 0x20, 0x62, 0x6f, 0x6c, 0x64, 0x3b, 0x22, 0x3e, 0x3c, 0x2f,
                                           0x73, 0x70, 0x61, 0x6e, 0x3e, 0x3c, 0x2f, 0x61, 0x3e, 0x3c, 0x73, 0x6d, 0x61, 0x6c, 0x6c, 0x3e, 0x3c, 0x61, 0x20, 0x68, 0x72, 0x65, 0x66,
                                           0x3d, 0x22, 0x2f, 0x53, 0x54, 0x4d, 0x33, 0x32, 0x48, 0x37, 0x78, 0x78, 0x54, 0x41, 0x53, 0x4b, 0x53, 0x2e, 0x68, 0x74, 0x6d, 0x6c, 0x22,
                                           0x3e, 0x3c, 0x73, 0x70, 0x61, 0x6e, 0x20, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x3d, 0x22, 0x63, 0x6f, 0x6c, 0x6f, 0x72, 0x3a, 0x20, 0x77, 0x68,
                                           0x69, 0x74, 0x65, 0x3b, 0x22, 0x3e, 0x4c, 0x69, 0x73, 0x74, 0x0d, 0x0a, 0x6f, 0x66, 0x20, 0x74, 0x61, 0x73, 0x6b, 0x73, 0x3c, 0x2f, 0x73,
                                           0x70, 0x61, 0x6e, 0x3e, 0x3c, 0x2f, 0x61, 0x3e, 0x3c, 0x2f, 0x73, 0x6d, 0x61, 0x6c, 0x6c, 0x3e, 0x3c, 0x2f, 0x74, 0x64, 0x3e, 0x0d, 0x0a,
                                           0x3c, 0x2f, 0x74, 0x72, 0x3e, 0x0d, 0x0a, 0x3c, 0x2f, 0x74, 0x62, 0x6f, 0x64, 0x79, 0x3e, 0x0d, 0x0a, 0x3c, 0x2f, 0x74, 0x61, 0x62, 0x6c,
                                           0x65, 0x3e, 0x0d, 0x0a, 0x3c, 0x62, 0x72, 0x3e, 0x0d, 0x0a, 0x3c, 0x2f, 0x73, 0x70, 0x61, 0x6e, 0x3e, 0x3c, 0x73, 0x70, 0x61, 0x6e, 0x20,
                                           0x73, 0x74, 0x79, 0x6c, 0x65, 0x3d, 0x22, 0x66, 0x6f, 0x6e, 0x74, 0x2d, 0x77, 0x65, 0x69, 0x67, 0x68, 0x74, 0x3a, 0x20, 0x62, 0x6f, 0x6c,
                                           0x64, 0x3b, 0x22, 0x3e, 0x3c, 0x2f, 0x73, 0x70, 0x61, 0x6e, 0x3e, 0x3c, 0x73, 0x6d, 0x61, 0x6c, 0x6c, 0x3e, 0x3c, 0x73, 0x70, 0x61, 0x6e,
                                           0x20, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x3d, 0x22, 0x66, 0x6f, 0x6e, 0x74, 0x2d, 0x66, 0x61, 0x6d, 0x69, 0x6c, 0x79, 0x3a, 0x20, 0x56, 0x65,
                                           0x72, 0x64, 0x61, 0x6e, 0x61, 0x3b, 0x22, 0x3e, 0x4e, 0x75, 0x6d, 0x62, 0x65, 0x72, 0x20, 0x6f, 0x66, 0x20, 0x70, 0x61, 0x67, 0x65, 0x20,
                                           0x68, 0x69, 0x74, 0x73, 0x3a, 0x26, 0x6e, 0x62, 0x73, 0x70, 0x3b, 0x0d, 0x0a, 0x0d, 0x0a, 0x3c, 0x2f, 0x73, 0x70, 0x61, 0x6e, 0x3e, 0x3c,
                                           0x2f, 0x73, 0x6d, 0x61, 0x6c, 0x6c, 0x3e, 0x0d, 0x0a, 0x3c, 0x2f, 0x62, 0x6f, 0x64, 0x79, 0x3e, 0x3c, 0x2f, 0x68, 0x74, 0x6d, 0x6c, 0x3e,
                                           0};

/* Private function prototypes -----------------------------------------------*/
/* Private functions ---------------------------------------------------------*/

static void print_http_cmd (const char * pBuf, u16_t buflen)
{
    while (buflen > 0 && *pBuf >= 32)
    {
        printf("%c", *pBuf);
        pBuf++;
        buflen--;
    }
    printf("\n");
}

void http_write_to_conn (const char *data, size_t len)
{

}

void (*pointer_name)(const char*, size_t);
typedef void (*http_write_func_t)(const char*, size_t);

//void http_write (struct netconn * conn, const char *data, size_t len)

void http_write_old (void * conn, const char *data, size_t len)
{
    netconn_write(conn, data, len, NETCONN_NOCOPY);

}

extern void feed_watchdog (void);


static void th_heartbeat (void * arg)
{
    uint32_t counter=0;
    while (1)
    {
        vTaskDelay(pdMS_TO_TICKS(1000));
        if (counter >0 && (counter % 60 == 0))
        {
            ppIntMessage("heart $ beat times", counter/60);
        }
        counter++;
        feed_watchdog();
    }
}

void th_blink_yellow (void * arg);
void th_blink_red (void * arg);


void ini_my_threads ()
{
    ppc("ini_my_threads");

    sys_thread_new("HEARTBEAT", th_heartbeat, NULL, 1 * DEFAULT_THREAD_STACKSIZE, WEBSERVER_THREAD_PRIO);
    sys_thread_new("BLINK_YELLOW", th_blink_yellow, NULL, 1 * DEFAULT_THREAD_STACKSIZE, WEBSERVER_THREAD_PRIO);
    sys_thread_new("BLINK_RED", th_blink_red, NULL, 1 * DEFAULT_THREAD_STACKSIZE, WEBSERVER_THREAD_PRIO);

}



err_t http_write(struct netconn *conn, const char *data, size_t len)
{
    if (!conn || !data || len == 0)
    {
        return ERR_ARG;
    }

    struct netconn *nc = (struct netconn *) conn;

    size_t totalSent = 0;

    while (totalSent < len)
    {
        size_t remaining = len - totalSent;
        const char *currentPtr = data + totalSent;

        err_t err = netconn_write(nc, currentPtr, remaining, NETCONN_COPY);
        if (err != ERR_OK)
        {
            // Optional Logging
            ppVal(err, "http_write failed-err $");
            return err;
        }

        totalSent += remaining;
    }

    return ERR_OK;
}

//__attribute__((weak)) void request_response (const char * pBufRequest, uint16_t reqBuflen, void * conn, const char *data, size_t len)
__attribute__((weak)) void request_response (const char * pBufRequest, uint16_t reqBuflen, void * conn)
{
    ppc("::request_response - overwrite me !");
    //http_write(conn, data, len);
}


/**
  * @brief serve tcp connection  
  * @param conn: pointer on connection structure 
  * @retval None
  */
static void http_server_serve (struct netconn * conn)
{
    struct netbuf * inbuf;
    err_t recv_err;
    char * buf;
    u16_t buflen;
    struct fs_file file;

    ppc("");

    /* Read the data from the port, blocking if nothing yet there.
     We assume the request (the part we care about) is in one netbuf */
    recv_err = netconn_recv(conn, &inbuf);

    if (recv_err == ERR_OK)
    {
        if (netconn_err(conn) == ERR_OK)
        {
            netbuf_data(inbuf, (void **) &buf, &buflen);

            if ((buflen >= 5) && (strncmp(buf, "POST /", 6) == 0))
            {
                pp_first_line(buf);

                request_response(buf, buflen, conn);
            }
            else if ((buflen >= 5) && (strncmp(buf, "GET /", 5) == 0))
            {
                pp_first_line(buf);


                // Check if request to get ST.gif
                if (strncmp((char const *) buf, "GET /STM32H7xx_files/ST.gif", 27) == 0)
                {
                    fs_open(&file, "/STM32H7xx_files/ST.gif");
                    netconn_write(conn, (const unsigned char *) (file.data), (size_t) file.len, NETCONN_NOCOPY);
                    fs_close(&file);
                }
                else if (strncmp((char const *) buf, "GET /STM32H7xx_files/stm32.jpg", 30) == 0)
                {
                    fs_open(&file, "/STM32H7xx_files/stm32.jpg");
                    netconn_write(conn, (const unsigned char *) (file.data), (size_t) file.len, NETCONN_NOCOPY);
                    fs_close(&file);
                }
                else if (strncmp((char const *) buf, "GET /STM32H7xx_files/logo.jpg", 29) == 0)
                {
                    fs_open(&file, "/STM32H7xx_files/logo.jpg");
                    netconn_write(conn, (const unsigned char *) (file.data), (size_t) file.len, NETCONN_NOCOPY);
                    fs_close(&file);
                }
                else if (strncmp(buf, "GET /STM32H7xxTASKS.html", 24) == 0)
                {
                    DynWebPage(conn);
                }
                else if ((strncmp(buf, "GET /STM32H7xx.html", 19) == 0))
                {
                    fs_open(&file, "/STM32H7xx.html");
                    netconn_write(conn, (const unsigned char *) (file.data), (size_t) file.len, NETCONN_NOCOPY);
                    fs_close(&file);
                }

                else
                {
                    request_response(buf, buflen, conn);

//                    if (strstr(buf, "GET /blinky")  || (strncmp(buf, "GET / ", 6) == 0))
//                    {
//                        request_response(buf, buflen, conn);
//                    }


                    // Load Error page
//                    fs_open(&file, "/404.html");
//                    netconn_write(conn, (const unsigned char *) (file.data), (size_t) file.len, NETCONN_NOCOPY);
//                    fs_close(&file);
                }
            }
        }
    }
    /* Close the connection (server closes in HTTP) */
    netconn_close(conn);

    /* Delete the buffer (netconn_recv gives us ownership,
     so we have to make sure to deallocate the buffer) */
    netbuf_delete(inbuf);
}



/**
  * @brief  http server thread 
  * @param arg: pointer on argument(not used here) 
  * @retval None
  */
static void http_server_netconn_thread (void * arg)
{
    struct netconn * conn, * newconn;
    err_t err, accept_err;

    /* Create a new TCP connection handle */
    conn = netconn_new(NETCONN_TCP);

    if (conn != NULL)
    {
        /* Bind to port 80 (HTTP) with default IP address */
        err = netconn_bind(conn, NULL, 80);

        if (err == ERR_OK)
        {
            /* Put the connection into LISTEN state */
            netconn_listen(conn);

            while (1)
            {
                /* accept any icoming connection */
                accept_err = netconn_accept(conn, &newconn);
                if (accept_err == ERR_OK)
                {
                    /* serve connection */
                    http_server_serve(newconn);

                    /* delete connection */
                    netconn_delete(newconn);
                }
            }
        }
    }
}

/**
  * @brief  Initialize the HTTP server (start its thread) 
  * @param  none
  * @retval None
  */
void http_server_netconn_init ()
{
    sys_thread_new("HTTP", http_server_netconn_thread, NULL, 6 * DEFAULT_THREAD_STACKSIZE, WEBSERVER_THREAD_PRIO);
//    sys_thread_new("HTTP", http_server_netconn_thread, NULL, 1 * DEFAULT_THREAD_STACKSIZE, WEBSERVER_THREAD_PRIO);  // stack overflow provozieren
}





/**
  * @brief  Create and send a dynamic Web Page. This page contains the list of 
  *         running tasks and the number of page hits. 
  * @param  conn pointer on connection structure 
  * @retval None
  */
void DynWebPage (struct netconn * conn)
{
    portCHAR PAGE_BODY[512];
    portCHAR pagehits[10] = {0};

    memset(PAGE_BODY, 0, 512);

    /* Update the hit count */
    nPageHits++;
    sprintf(pagehits, "%d", (int) nPageHits);
    strcat(PAGE_BODY, pagehits);
    strcat((char *) PAGE_BODY, "<pre><br>Name          State  Prio  Stack  Num");
    strcat((char *) PAGE_BODY, "<br>--------------------------------------------<br>");

    /* The list of tasks and their status */
    vTaskList((char *) (PAGE_BODY + strlen(PAGE_BODY)));
    strcat((char *) PAGE_BODY, "<br><br>--------------------------------------------");
    strcat((char *) PAGE_BODY, "<br>X : Running, B : Blocked, R : Ready, D : Deleted, S : Suspended<br>");

    /* Send the dynamically generated page */
    netconn_write(conn, PAGE_START, strlen((char *) PAGE_START), NETCONN_COPY);
    netconn_write(conn, PAGE_BODY, strlen(PAGE_BODY), NETCONN_COPY);
}


